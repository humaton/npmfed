#!/usr/bin/env ruby

require "bundler/setup"
require "npmfed"
require "thor"
require 'colorize'

class MyCLI < Thor
  @debug = false
  desc "check NPM PACKAGE NAME", "Get list of npm package dependencies and corresponding fedora builds"
  option :create
  option :deps
  def check(name, version=nil)
    package = Npmfed::NpmPackage.new name, @debug

    puts "#{package.name}-#{package.version} dependencies:"
    puts "================================================"

    package.dependencies.each {|name, data|
      if data.nil?
        puts name + "  FAIL  ".to_s.red
      else
        puts name + "   OK  ".to_s.green + data[:builds].to_s
      end
    }
    
    puts "Package #{name} have #{package.dependencies.count} dependencies in npm registry"
    puts "Packaged in fedora: #{package.dependencies.select{|name, data| name unless data.nil? }.count}"
    puts "Not in fedora: " + "#{package.dependencies.select{|name, data| name if data.nil? }.count}".red
    
    if @debug
      puts "Koji requests " + package.koji_requests
      puts "Pkgdb requests " + package.pkgdb_requests
    end

    if options[:create]
      FileUtils.mkdir_p "#{package.rpmname}"
      tarball_uri = URI package.tarball
      `wget #{tarball_uri} -P #{package.rpmname}/`

      if options[:deps]
        package.dependencies.each do |name, data|
          if data.nil?
          #dependency = Npmfed::NpmPackage.new name, @debug
          puts name + "  DOWNLOADING  ".to_s.red
          FileUtils.mkdir_p "#{package.rpmname}/nodejs-#{name}"
          #tarball_uri = URI dependency.tarball
          #`wget #{tarball_uri} -P nodejs-#{name}/`
          end
        end
      end
    end
  end

  desc 'test IDES', 'Used for testing shit'
  def test(name)
  end

  desc 'download ...' , '... IDES'
  def download
  end
end

MyCLI.start(ARGV)

